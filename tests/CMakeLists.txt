#
#
# Unit Tests Target

# Compile the Vala code to C
vala_precompile(VALA_UNIT_TESTS_C
    test_case.vala
    test_main.vala
    test_my_class.vala
PACKAGES
    gio-2.0
    gee-0.8
    posix
CUSTOM_VAPIS
    ${CMAKE_BINARY_DIR}/my-project/my-project-${MY_PROJECT_VERSION_API}.vapi)

# Generate an executable called "my_project_unit_tests" to run the tests.
add_executable(test-${PROJECT_NAME}
    ${VALA_UNIT_TESTS_C})

# We need to add the directory where the C header for our library is
# installed, otherwise we'll get an error from the C compiler.
set_target_properties(test-${PROJECT_NAME} PROPERTIES
    INCLUDE_DIRECTORIES ${CMAKE_BINARY_DIR}/my-project)

# Any libraries that your tests need to link to should go here.
# Usually this will just be your library.
target_link_libraries(test-${PROJECT_NAME}
    my-project-${MY_PROJECT_VERSION_API})

# List of tests in the `test-${PROJECT_NAME}' executable that you
# want to execute.  Note that this is a list; to add additional tests
# you don't need to quote them, just use whitespace to separate them
# and you're done.
set(MY_PROJECT_TESTS
    /my_class/foo)

# Add the tests in the MY_PROJECT_TESTS list to ctest
foreach(test_name ${MY_PROJECT_TESTS})
    add_test(NAME ${test_name}
        COMMAND $<TARGET_FILE:test-${PROJECT_NAME}> -p ${test_name})
endforeach(test_name)

# Generate a .gitignore
file(WRITE  ".gitignore" "# Automatically generated by CMake, do not modify.\n")
foreach(file
    ".gitignore"
    "test-${PROJECT_NAME}${CMAKE_EXECUTABLE_SUFFIX}")
  file(APPEND ".gitignore" "/${file}\n")
endforeach(file)
foreach(file ${VALA_UNIT_TESTS_C})
  string(REPLACE "${CMAKE_CURRENT_BINARY_DIR}/" "" file ${file})
  file(APPEND ".gitignore" "/${file}\n")
endforeach(file)
